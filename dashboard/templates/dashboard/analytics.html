{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Analytics Â· MediCare{% endblock %}

{% block brand_url %}#{% endblock %}

{% block nav_tabs %}
  <button class="nav-tab active" onclick="switchTab('overview', this)">
    Overview
  </button>
  <button class="nav-tab" onclick="switchTab('doctors', this)">
    By Doctor
    <span class="tab-count">{{ doctors_insights|length }}</span>
  </button>
{% endblock %}

{% block extra_styles %}
<style>
  /* â”€â”€ Stats grid â”€â”€ */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 1.25rem 1.5rem;
    display: flex;
    flex-direction: column;
    gap: .4rem;
  }
  .stat-card .stat-label {
    font-size: .67rem;
    text-transform: uppercase;
    letter-spacing: .09em;
    color: var(--muted);
  }
  .stat-card .stat-value {
    font-family: 'DM Serif Display', serif;
    font-size: 2rem;
    line-height: 1;
    color: var(--text);
  }
  .stat-card .stat-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    margin-top: auto;
  }

  /* â”€â”€ Chart card â”€â”€ */
  .chart-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 1.75rem;
    margin-bottom: 2rem;
  }
  .chart-card-head {
    font-family: 'DM Serif Display', serif;
    font-size: 1.1rem;
    font-weight: 400;
    margin-bottom: 1.5rem;
    color: var(--text);
  }
  .chart-wrap {
    max-width: 380px;
    margin: 0 auto;
  }

  /* â”€â”€ Doctors table â”€â”€ */
  .data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: .85rem;
  }
  .data-table thead th {
    font-size: .67rem;
    text-transform: uppercase;
    letter-spacing: .09em;
    color: var(--muted);
    font-weight: 600;
    padding: .6rem 1rem;
    border-bottom: 2px solid var(--border);
    text-align: left;
    white-space: nowrap;
  }
  .data-table tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background .12s;
  }
  .data-table tbody tr:last-child { border-bottom: none; }
  .data-table tbody tr:hover { background: var(--bg); }
  .data-table tbody td {
    padding: .85rem 1rem;
    color: var(--text);
    font-weight: 500;
  }
  .data-table tbody td:first-child { font-weight: 600; }
  .pill {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 20px;
    font-size: .75rem;
    font-weight: 600;
  }
  .pill-completed  { background: #eaf5ee; color: #2e7d4f; }
  .pill-cancelled  { background: #fde8e8; color: #8a0000; }
  .pill-no_show    { background: #f5e8e8; color: #7a2020; }
  .pill-requested  { background: #fdf3e0; color: #8a5e00; }
  .pill-confirmed  { background: #e3f1f7; color: #1a6180; }
  .pill-checked_in { background: #e8f5ec; color: #2e7d4f; }

  .total-badge {
    font-family: 'DM Serif Display', serif;
    font-size: 1.1rem;
  }

  @media (max-width: 760px) {
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .chart-wrap { max-width: 100%; }
    .data-table { display: block; overflow-x: auto; }
  }
</style>
{% endblock %}

{% block content %}

  <div class="pg-header">
    <h1>Appointments <em>Analytics</em> ðŸ“Š</h1>
    <p>Overall system-wide appointment metrics and doctor performance.</p>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB 1 Â· OVERVIEW
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-overview" class="tab-panel active">

    <!-- Stat cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Completed</div>
        <div class="stat-value">{{ appointments_insights.completed_appointments }}</div>
        <div class="stat-dot" style="background:#6abf8a;"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Confirmed</div>
        <div class="stat-value">{{ appointments_insights.confirmed_appointments }}</div>
        <div class="stat-dot" style="background:#6a9fb5;"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Checked In</div>
        <div class="stat-value">{{ appointments_insights.checked_in_appointments }}</div>
        <div class="stat-dot" style="background:#c8a97e;"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Requested</div>
        <div class="stat-value">{{ appointments_insights.requested_appointments }}</div>
        <div class="stat-dot" style="background:#f0c060;"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Cancelled</div>
        <div class="stat-value">{{ appointments_insights.cancelled_appointments }}</div>
        <div class="stat-dot" style="background:#e07070;"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">No Show</div>
        <div class="stat-value">{{ appointments_insights.no_show_appointments }}</div>
        <div class="stat-dot" style="background:#c07070;"></div>
      </div>
    </div>

    <!-- Pie chart -->
    <div class="chart-card">
      <div class="chart-card-head">Status Breakdown</div>
      <div class="chart-wrap">
        <canvas id="appointmentsPieChart"></canvas>
      </div>
    </div>

  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB 2 Â· BY DOCTOR
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-doctors" class="tab-panel">

    <div class="chart-card">
      <div class="chart-card-head">Doctor-wise Appointment Metrics</div>

      {% if doctors_insights %}
      <table class="data-table">
        <thead>
          <tr>
            <th>Doctor</th>
            <th>Total</th>
            <th>Completed</th>
            <th>Confirmed</th>
            <th>Checked In</th>
            <th>Requested</th>
            <th>Cancelled</th>
            <th>No Show</th>
          </tr>
        </thead>
        <tbody>
          {% for doctor in doctors_insights %}
          <tr>
            <td>#{{ doctor.doctor_id }}</td>
            <td><span class="total-badge">{{ doctor.total_appointments }}</span></td>
            <td><span class="pill pill-completed">{{ doctor.completed_appointments }}</span></td>
            <td><span class="pill pill-confirmed">{{ doctor.confirmed_appointments }}</span></td>
            <td><span class="pill pill-checked_in">{{ doctor.checked_in_appointments }}</span></td>
            <td><span class="pill pill-requested">{{ doctor.requested_appointments }}</span></td>
            <td><span class="pill pill-cancelled">{{ doctor.cancelled_appointments }}</span></td>
            <td><span class="pill pill-no_show">{{ doctor.no_show_appointments }}</span></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <div class="empty-state">
          <svg viewBox="0 0 24 24"><path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"/></svg>
          <p>No doctor data available.</p>
        </div>
      {% endif %}
    </div>

  </div>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/charts.js' %}"></script>
<script>
  const appointmentsData = {
    completed_appointments:  {{ appointments_insights.completed_appointments }},
    cancelled_appointments:  {{ appointments_insights.cancelled_appointments }},
    no_show_appointments:    {{ appointments_insights.no_show_appointments }},
    requested_appointments:  {{ appointments_insights.requested_appointments }},
    confirmed_appointments:  {{ appointments_insights.confirmed_appointments }},
    checked_in_appointments: {{ appointments_insights.checked_in_appointments }},
  };
  renderAppointmentsPieChart('appointmentsPieChart', appointmentsData);
</script>
{% endblock %}